From: Lucid-Duck <uglytoiletduck@gmail.com>
Subject: [PATCH 4/4] usb: fix increment/decrement race condition

Move atomic_inc() BEFORE usb_submit_urb() to prevent race with completion
callback. The USB core may complete URBs extremely fast (or even inline),
and the completion callback can run on a different CPU before the
submitting code resumes.

Original bug:
1. write_port() submits URB
2. USB core completes immediately
3. Completion callback calls atomic_dec()
4. Submitting code resumes and calls atomic_inc()
5. Result: inflight goes 0 -> -1 -> 0 (race!)

Fix: Pre-increment before submit, rollback on failure.

Discovered via debug instrumentation showing:
  "TX flow ctrl: decrement when inflight=0 ch=0"

Signed-off-by: Lucid-Duck <uglytoiletduck@gmail.com>
---
 rtw89/usb.c | 14 ++++++++------
 rtw89/usb.h |  2 +-
 2 files changed, 9 insertions(+), 7 deletions(-)

diff --git a/rtw89/usb.c b/rtw89/usb.c
index eb45c30..a7d9f21 100644
--- a/rtw89/usb.c
+++ b/rtw89/usb.c
@@ -343,18 +343,20 @@ static void rtw89_usb_ops_tx_kick_off(struct rtw89_dev *rtwdev, u8 txch)

 		skb_queue_tail(&txcb->tx_ack_queue, skb);

+		/* Increment BEFORE submit to avoid race with completion callback */
+		if (txch != RTW89_TXCH_CH12)
+			atomic_inc(&rtwusb->tx_inflight[txch]);
+
 		ret = rtw89_usb_write_port(rtwdev, txch, skb->data, skb->len,
 					   txcb);
 		if (ret) {
+			/* Undo increment on failure */
+			if (txch != RTW89_TXCH_CH12)
+				atomic_dec(&rtwusb->tx_inflight[txch]);
+
 			if (ret != -ENODEV)
 				rtw89_err(rtwdev, "write port txch %d failed: %d\n",
 					  txch, ret);

 			skb_dequeue(&txcb->tx_ack_queue);
 			kfree(txcb);
 			rtw89_usb_tx_free_skb(rtwdev, txch, skb);
-		} else {
-			/* Skip tracking for firmware command channel */
-			if (txch != RTW89_TXCH_CH12)
-				atomic_inc(&rtwusb->tx_inflight[txch]);
 		}
 	}
 }
diff --git a/rtw89/usb.h b/rtw89/usb.h
index bdef02c..9f554b5 100644
--- a/rtw89/usb.h
+++ b/rtw89/usb.h
@@ -24,7 +24,7 @@

 /* TX flow control: max in-flight URBs per channel */
-#define RTW89_USB_MAX_TX_URBS_PER_CH	4  /* TEMP: testing backpressure */
+#define RTW89_USB_MAX_TX_URBS_PER_CH	32

 struct rtw89_usb_info {
 	u32 usb_host_request_2;
